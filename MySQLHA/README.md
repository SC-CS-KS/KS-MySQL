# MySQL HA


## 数据一致性
## 强制读主库
```md
对于一些update操作后重新读比较多的场景，强制要求读主库，
或者在更新DB后立马返回主库更新后的结果，减少更新后立马读取数据的业务场景。

优点是操作简单，逻辑简单，缺点也是非常明显那就是从数据库完全成为一个备库，对性能上没有丝毫的帮助。
为了提升性能，我只能业务进行缓存了。
```
## 主从同步
* 全同步复制
```md
指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。很明显，全同步的效率太低了。
假设又一个从库，写主库需要话200ms的时间，那么，使用全同步复制的话一个请求会至少需要400ms+的时间（双倍的写时间加上一定的TCP往返时间）。\
```
* 异步复制
```md
MySQL默认的复制即是异步的，主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理。
这个会造成可能主库已经写完了，但是从库的数据还没有同步，读到的可能是旧数据。 
另外一方面，如果某个时间主DB宕机了，那么从库还没有同步到最新的数据。
```
* 半同步复制
```md
介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，
而是等待至少一个从库接收到并写到relay log中才返回给客户端。
```
```md
业务方提交一个写操作给数据库，主数据库写完记录后，commit成功后，会像从库发起写bin log的请求，
因为写日志的数据实际上非常的快，写完就返回，相当于一次写操作要多一次tcp的往返时间。
```
```md
事实上，从主库返回成功，到备库异步提交成功，还是有一定的时间差，不过这个时间相对于异步复制，已经大大减少了。
```
## 数据库中间件路由
```md
数据库中间件维护一个cache，预估好数据库主从同步的时间，
例如200ms，如果某个key在200ms里面更新过，那么就读取主库的数据，否则就读从库的数据。

除此之外，也会维护一定的数据缓存，在Update的时候，同时把主库的数据select出来，放在缓存中，加快数据库的读取速度。
```
